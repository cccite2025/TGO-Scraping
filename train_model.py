import pandas as pd
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.naive_bayes import MultinomialNB
from sklearn.pipeline import make_pipeline
import joblib # Library ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö save/load ‡πÇ‡∏°‡πÄ‡∏î‡∏•

print("--- 1. ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≠‡∏ô (Training Data)... ---")
# 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "‡πÄ‡∏â‡∏•‡∏¢" ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏ó‡∏≥‡πÑ‡∏ß‡πâ
try:
    df = pd.read_csv('training_data.csv')
    df = df[['product_name', 'correct_category']].dropna()
except FileNotFoundError:
    print("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå training_data.csv! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô")
    exit()

if df.empty:
    print("‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤ (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå CSV)")
    exit()

print(f"‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à {len(df)} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")

# 2. ‡πÅ‡∏ö‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô X (‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° = ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå) ‡πÅ‡∏•‡∏∞ y (‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö = ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà)
X_train = df['product_name']
y_train = df['correct_category']

print("--- 2. ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏°‡πÄ‡∏î‡∏•... ---")
# 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á "‡∏ó‡πà‡∏≠" (Pipeline)
#    - TfidfVectorizer: ‡∏Ñ‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡πÄ‡∏ä‡πà‡∏ô "‡∏õ‡∏π‡∏ô‡∏â‡∏≤‡∏ö") ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
#    - MultinomialNB: ‡∏Ñ‡∏∑‡∏≠ "‡∏™‡∏°‡∏≠‡∏á" AI (Naive Bayes) ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
model_pipeline = make_pipeline(
    TfidfVectorizer(analyzer='char', ngram_range=(2, 5)), # üí° ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ: ‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏à‡∏≤‡∏Å "‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£" (‡πÄ‡∏ä‡πà‡∏ô "‡∏õ‡∏π‡∏ô‡∏â", "‡∏â‡∏≤‡∏ö‡∏ú") ‡∏à‡∏∞‡πÅ‡∏°‡πà‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏≥
    MultinomialNB()
)

print("--- 3. ‡∏Å‡∏≥‡∏•‡∏±‡∏á '‡∏™‡∏≠‡∏ô' (Training) ‡πÇ‡∏°‡πÄ‡∏î‡∏•... ---")
# 4. "‡∏™‡∏≠‡∏ô" ‡πÇ‡∏°‡πÄ‡∏î‡∏• ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ X_train (‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°) ‡πÅ‡∏•‡∏∞ y_train (‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö)
model_pipeline.fit(X_train, y_train)

print("--- 4. ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•... ---")
# 5. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å "‡∏ó‡πà‡∏≠" ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ó‡∏±‡πâ‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏•‡∏á TF-IDF ‡πÅ‡∏•‡∏∞ ‡∏™‡∏°‡∏≠‡∏á AI) ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå
#    ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏ü‡∏•‡πå‡∏ä‡∏∑‡πà‡∏≠ category_model.joblib
try:
    joblib.dump(model_pipeline, 'category_model.joblib')
    print("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (category_model.joblib)")
    print("\n‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ô‡∏≥‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå Scraper ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢")
except Exception as e:
    print(f"‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {e}")