<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>กำลังโหลด... | CPF Green Material</title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- 1. ธีมสีใหม่ตามที่กำหนด --- */
        :root {
            --green-dark: #1b5e20;
            --green: #2e7d32;
            --green-light: #e8f5e9;
            --blue: #0d47a1;
            --blue-light: #e3f2fd; /* <<< เพิ่มสีฟ้าอ่อน */
            --gold: #ffb300;
            --gold-light: #fff176;
            --gold-hover: #ffa000;
            --bg-light: #f9fbe7;
            --border-gold: #ffd54f;
            --white: #ffffff;
            --text-dark: #4e342e;
            --shadow-light: rgba(0, 0, 0, 0.1);
        }
        
        /* --- 2. การปรับใช้ธีมสี --- */
        body { 
            font-family: 'Kanit', sans-serif; 
            background-color: var(--bg-light); /* ธีมใหม่ */
            color: var(--text-dark); /* ธีมใหม่ */
            min-height: 100vh;
        }
        .card {
            background-color: var(--white); /* ธีมใหม่ */
            border: 1px solid var(--green-light); /* ธีมใหม่ */
            border-radius: 1rem;
            box-shadow: 0 4px 8px var(--shadow-light); /* ธีมใหม่ */
        }
        .text-green-dark { color: var(--green-dark); }
        .text-green { color: var(--green); }
        .text-blue { color: var(--blue); }
        .text-text-dark { color: var(--text-dark); }
        .bg-green { background-color: var(--green); }
        .hover\:bg-green-dark:hover { background-color: var(--green-dark); }
        .hover\:text-green:hover { color: var(--green); }
        .loader-spin { border-top-color: var(--green); }
        
        /* --- 3. สไตล์ปุ่ม (อัปเดตสี) --- */
        .tgo-link-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            text-align: center;
            color: var(--text-dark); /* ธีมใหม่ (น้ำตาล) */
            background-color: var(--gold-light);
            border: 2px solid var(--gold);
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }
        .tgo-link-button:hover {
            background-color: var(--gold);
            color: var(--text-dark); /* ธีมใหม่ (น้ำตาล) */
            box-shadow: 0 4px 8px var(--shadow-light);
        }

        .back-button-green {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            text-align: center;
            color: var(--green-dark);
            background-color: var(--green-light);
            border: 2px solid var(--green);
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .back-button-green:hover {
            background-color: var(--green);
            color: var(--white);
            border-color: var(--green-dark);
            box-shadow: 0 4px 8px var(--shadow-light);
        }
        
        /* --- 4. สไตล์ตาราง (อัปเดตสี) --- */
        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center; /* <<< เพิ่ม alignment */
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--green-light); /* ธีมใหม่ */
        }
        .detail-item-label {
            display: flex; /* <<< เพิ่ม */
            align-items: center; /* <<< เพิ่ม */
            font-weight: 600;
            color: var(--text-dark); /* ธีมใหม่ (น้ำตาล) */
            opacity: 0.7; /* ทำให้จางลง */
            margin-right: 1rem;
        }
        .detail-item-value {
            font-weight: 500;
            text-align: right;
            color: var(--text-dark); /* ธีมใหม่ */
        }

        /* --- 5. สไตล์เพิ่มเติม (ที่เพิ่มใหม่) --- */
        .page-title-decorated {
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.05);
        }

        .detail-icon {
            width: 1.125rem; /* 18px */
            height: 1.125rem; /* 18px */
            margin-right: 0.5rem; /* 8px */
            color: var(--text-dark);
            opacity: 0.6;
            flex-shrink: 0;
        }

        #product-image {
            border: 1px solid var(--green-light);
            box-shadow: 0 10px 15px -3px var(--shadow-light), 0 4px 6px -4px var(--shadow-light);
            transition: all 0.3s ease;
        }
        #product-image:hover {
            transform: scale(1.02);
            box-shadow: 0 20px 25px -5px var(--shadow-light), 0 8px 10px -6px var(--shadow-light);
        }
    </style>
</head>
<body>

    <div class="min-h-screen flex flex-col">
        
        <header class="bg-white/90 backdrop-blur-lg sticky top-0 z-30 shadow-sm border-b border-green-light">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center gap-4">
                
                <div>
                    <button id="back-button" class="md:hidden flex items-center gap-2 text-sm font-medium text-slate-600 hover:text-green transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                    </button>
                    <button id="back-button-desktop" class="hidden md:flex items-center gap-2 text-sm font-medium text-slate-600 hover:text-green transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                        ย้อนกลับ
                    </button>
                </div>
                
                <div class="flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="12" y1="8" x2="12" y2="16"></line>
                        <line x1="8" y1="12" x2="16" y2="12"></line>
                        <title>CPF Logo</title>
                    </svg>
                    <h1 class="text-xl font-bold text-green-dark">CPF Green Material</h1>
                </div>

            </div>
        </header>

        <main class="container mx-auto px-6 py-8 flex-grow">
            
            <div id="breadcrumbs" class="mb-6 text-sm text-slate-600 font-light flex items-center gap-2"></div>

            <div id="loader" class="text-center py-20">
                <div class="w-12 h-12 border-4 border-slate-200 rounded-full animate-spin mx-auto loader-spin"></div>
                <p class="mt-4 text-slate-600">กำลังโหลดข้อมูลสินค้า...</p>
            </div>
            
            <div id="error-message" class="hidden text-center py-20">
                <h2 class="text-2xl font-bold text-red-600">เกิดข้อผิดพลาด</h2>
                <p id="error-text" class="text-lg text-slate-600 mt-2"></p>
                <a href="index.html" class="mt-6 inline-block bg-green hover:bg-green-dark text-white px-5 py-3 rounded-lg font-semibold text-base transition-colors duration-300">
                    กลับสู่หน้าแรก
                </a>
            </div>

            <div id="product-detail-content" class="hidden">
                <div class="card p-6 md:p-10">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12">
                        
                        <div>
                            <img id="product-image" src="" alt="รูปภาพสินค้า" class="w-full h-auto object-cover rounded-lg">
                        </div>
                        
                        <div>
                            <h1 id="product-name" class="text-3xl md:text-4xl font-extrabold text-green-dark tracking-tight page-title-decorated"></h1>
                            <p id="company-name" class="text-lg text-slate-600 mt-2"></p>
                            
                            <div class="mt-6 mb-8">
                                <span id="label-type-badge" class="inline-flex items-center rounded-full px-4 py-1 text-base font-medium">
                                </span>
                            </div>

                            <div class="detail-list space-y-3">
                                <div class="detail-item">
                                    <span class="detail-item-label">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><path d="M5 18H3c-1.1 0-2-.9-2-2V8c0-1.1.9-2 2-2h2"></path><path d="M19 6h2c1.1 0 2 .9 2 2v8c0 1.1-.9 2-2 2h-2"></path><path d="M10 6h4"></path><path d="M10 18h4"></path><path d="M8 6v12"></path><path d="M16 6v12"></path></svg>
                                        รหัสสินค้า
                                    </span>
                                    <span id="product-id" class="detail-item-value"></span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-item-label">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
                                        หมวดหมู่
                                    </span>
                                    <span id="category" class="detail-item-value"></span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-item-label">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><path d="M11 20A7 7 0 0 1 11 6h2a2 2 0 0 1 2 2v0a2 2 0 0 1-2 2h-2"></path><path d="M4 12A8 8 0 0 1 12 4h0a8 8 0 0 1 8 8v0a8 8 0 0 1-8 8h-4"></path><path d="M18 16h.01"></path><path d="M16 13h.01"></path></svg>
                                        ค่าคาร์บอน
                                    </span>
                                    <span id="carbon-value" class="detail-item-value"></span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-item-label">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line></svg>
                                        หน่วย
                                    </span>
                                    <span id="carbon-unit" class="detail-item-value"></span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-item-label">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                                        หน่วยการทำงาน
                                    </span>
                                    <span id="functional-unit" class="detail-item-value break-all"></span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-item-label">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                                        ขอบเขต
                                    </span>
                                    <span id="scope" class="detail-item-value"></span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-item-label">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="detail-icon"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                                        วันที่รับรอง
                                    </span>
                                    <span id="cert-dates" class="detail-item-value"></span>
                                </div>
                            </div>

                            <div class="mt-10 flex justify-between items-center">
                                <button onclick="goBack()" class="back-button-green">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                                    ย้อนกลับ
                                </button>
                                <a id="external-link" href="#" target="_blank" rel="noopener noreferrer" class="tgo-link-button">
                                    ดูข้อมูลต้นฉบับที่ TGO
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ml-2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                                </a>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

        </main>

        <footer class="bg-white mt-12 py-6 border-t border-green-light">
            <div class="container mx-auto px-6 text-center text-sm text-slate-600">
                <p>&copy; 2024 CPF Green Material. All Rights Reserved.</p>
            </div>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Supabase Client Setup ---
            const SUPABASE_URL = 'https://pyfxrgrogevqlrqqiwks.supabase.co'; 
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5ZnhyZ3JvZ2V2cWxycXFpd2tzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5OTc4MjUsImV4cCI6MjA3NTU3MzgyNX0.NmTap3b7S5X7yKWfKHLc3KxeLARn9wTHMMpYBDZwWEg';
            
            if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
                showError("Supabase config ไม่ถูกต้อง");
                return;
            }
            const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // --- DOM Elements ---
            const loader = document.getElementById('loader');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const content = document.getElementById('product-detail-content');
            const breadcrumbs = document.getElementById('breadcrumbs');
            const backButton = document.getElementById('back-button');
            const backButtonDesktop = document.getElementById('back-button-desktop');

            const productNameEl = document.getElementById('product-name');
            const companyNameEl = document.getElementById('company-name');
            const productImageEl = document.getElementById('product-image');
            const labelBadgeEl = document.getElementById('label-type-badge');
            const productIdEl = document.getElementById('product-id');
            const categoryEl = document.getElementById('category');
            const carbonValueEl = document.getElementById('carbon-value');
            const carbonUnitEl = document.getElementById('carbon-unit');
            const functionalUnitEl = document.getElementById('functional-unit');
            const scopeEl = document.getElementById('scope');
            const certDatesEl = document.getElementById('cert-dates');
            const externalLinkEl = document.getElementById('external-link');

            // --- Helper Functions ---
            function showLoader() {
                loader.classList.remove('hidden');
                errorMessage.classList.add('hidden');
                content.classList.add('hidden');
            }
            function hideLoader() {
                loader.classList.add('hidden');
            }
            function showError(message) {
                hideLoader();
                errorText.textContent = message;
                errorMessage.classList.remove('hidden');
            }
            function formatDate(dateString) {
                if (!dateString) return 'N/A';
                try {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
                } catch (e) {
                    return dateString;
                }
            }

            // --- Main Fetch Function ---
            async function fetchProductDetails(id) {
                showLoader();
                let { data, error } = await _supabase.from('materials').select('*').eq('product_id', id).single(); 
                hideLoader();
                if (error || !data) {
                    console.error('Error fetching product:', error);
                    showError(`ไม่พบข้อมูลสำหรับรหัส: ${id}`);
                } else {
                    renderProductDetails(data);
                }
            }

            // --- Main Render Function ---
            function renderProductDetails(material) {
                document.title = `${material.product_name || 'รายละเอียดสินค้า'} | CPF Green Material`;
                
                breadcrumbs.innerHTML = `
                    <a href="index.html" class="hover:text-green transition-colors">หน้าแรก</a>
                    <span class="text-slate-400 mx-2">/</span>
                    <a href="index.html" onclick="goBack(event)" class="hover:text-green transition-colors">${material.label_type || 'Products'}</a>
                    <span class="text-slate-400 mx-2">/</span>
                    <span class="font-medium text-text-dark">${material.product_name || ''}</span>
                `;

                productNameEl.textContent = material.product_name || 'N/A';
                companyNameEl.textContent = material.company_name || 'N/A';
                
                // อัปเดต Placeholder เป็นธีมใหม่ (เขียว/น้ำตาล)
                productImageEl.src = material.image_url && material.image_url !== 'N/A' 
                    ? material.image_url 
                    : `https://placehold.co/600x400/e8f5e9/4e342e?text=${encodeURIComponent(material.product_name || 'No Image')}`;
                
                labelBadgeEl.textContent = material.label_type;
                if (material.label_type === 'CFR') {
                    // <<< แก้ไข: ใช้ var(--blue-light) ที่กำหนดไว้ใน CSS
                    labelBadgeEl.style.backgroundColor = 'var(--blue-light)'; 
                    labelBadgeEl.style.color = 'var(--blue)';
                } else {
                    labelBadgeEl.style.backgroundColor = 'var(--green-light)';
                    labelBadgeEl.style.color = 'var(--green-dark)';
                }

                productIdEl.textContent = material.product_id || 'N/A';
                categoryEl.textContent = material.category || 'N/A';
                carbonValueEl.textContent = material.carbon_value ? material.carbon_value.toLocaleString() : '-';
                carbonUnitEl.textContent = material.carbon_unit || 'N/A';
                functionalUnitEl.textContent = material.functional_unit || 'N/A';
                scopeEl.textContent = material.scope || 'N/A';
                certDatesEl.textContent = `${formatDate(material.cert_start_date)} - ${formatDate(material.cert_end_date)}`;

                if (material.detail_page_url && material.detail_page_url.trim() !== '') {
                    externalLinkEl.href = material.detail_page_url;
                    externalLinkEl.classList.remove('hidden');
                } else {
                    externalLinkEl.classList.add('hidden');
                }
                
                content.classList.remove('hidden');
            }

            // --- Navigation ---
            function goBack(event = null) {
                if(event) event.preventDefault();
                if (document.referrer && (document.referrer.includes('index.html') || document.referrer.includes(window.location.host))) {
                    window.history.back();
                } else {
                    window.location.href = 'index.html';
                }
            }
            
            function goHome() {
                window.location.href = 'index.html';
            }

            window.goBack = goBack;
            window.goHome = goHome;
            backButton.addEventListener('click', goBack);
            backButtonDesktop.addEventListener('click', goBack);

            // --- Initial Load ---
            const params = new URLSearchParams(window.location.search);
            const productId = params.get('id');

            if (!productId) {
                showError("ไม่พบรหัสสินค้าใน URL");
            } else {
                fetchProductDetails(productId);
            }
        });
    </script>
</body>
</html>