<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GreenBuild | แคตตาล็อกวัสดุก่อสร้างรักษ์โลก</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2/tsparticles.bundle.min.js"></script>
    
    <style>
        :root {
            --green-dark: #1b5e20;
            --green: #2e7d32;
            --blue: #0d47a1;
            --gold: #ffb300;
            --gold-light: #fff176;
            --gold-hover: #ffa000;
            --red-dark: #c62828;
            --bg-light: #f9fbe7;
            --border-gold: #ffd54f;
            --white: #ffffff;
            --text-dark: #4e342e;
            --grey-light: #f5f5f5;
            --grey-medium: #eeeeee;
            --grey-dark: #757575;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg-light);
            color: var(--green-dark);
            min-height: 100vh;
        }
        
        .card-hover {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        .card-hover::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        .card-hover:hover::before {
            left: 100%;
        }
        .card-hover:hover {
            transform: translateY(-12px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        .card-tilt {
            transition: transform 0.1s ease-out;
            will-change: transform;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, var(--green) 0%, var(--blue) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .animated-bg {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.95) 100%);
            backdrop-filter: blur(10px);
        }
        
        .icon-container {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .icon-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: rotate 4s linear infinite;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .card-hover:hover .icon-container::before {
            opacity: 1;
        }
        
        @keyframes rotate {
            to { transform: rotate(360deg); }
        }
        
        .category-concrete { background: linear-gradient(135deg, #78909c 0%, #546e7a 100%); }
        .category-steel { background: linear-gradient(135deg, #90a4ae 0%, #607d8b 100%); }
        .category-wood { background: linear-gradient(135deg, #a1887f 0%, #8d6e63 100%); }
        .category-tiles { background: linear-gradient(135deg, #ef9a9a 0%, #e57373 100%); }
        .category-paint { background: linear-gradient(135deg, #ce93d8 0%, #ba68c8 100%); }
        .category-glass { background: linear-gradient(135deg, #81d4fa 0%, #4fc3f7 100%); }
        .category-insulation { background: linear-gradient(135deg, #ffcc80 0%, #ffa726 100%); }
        .category-default { background: linear-gradient(135deg, #81c784 0%, #66bb6a 100%); }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        @keyframes slide-up {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .float-animation {
            animation: float 3s ease-in-out infinite;
        }
        
        .product-card-img {
            position: relative;
            overflow: hidden;
        }
        
        .product-card-img::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, transparent 0%, rgba(0, 0, 0, 0.3) 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .card-hover:hover .product-card-img::after {
            opacity: 1;
        }
        
        @keyframes pulse-ring {
            0% {
                transform: scale(0.9);
                opacity: 1;
            }
            100% {
                transform: scale(1.3);
                opacity: 0;
            }
        }
        
        #scroll-to-top::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 50%;
            background: var(--gold);
            animation: pulse-ring 2s infinite;
            z-index: -1;
        }
    </style>
</head>
<body>
    <div id="particles-bg" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;"></div>

    <div class="min-h-screen flex flex-col relative z-10">
        <header class="animated-bg sticky top-0 z-30 shadow-lg border-b border-white/50">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-green-500 to-green-700 flex items-center justify-center shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                            <path d="m9 12 2 2 4-4"></path>
                        </svg>
                    </div>
                    <h1 class="text-xl font-bold gradient-text">GreenBuild Catalog</h1>
                </div>
                
                <div class="relative w-full max-w-xs ml-4">
                    <input id="search-input" type="text" placeholder="ค้นหาวัสดุ..." class="w-full pl-10 pr-4 py-2 rounded-xl border border-[var(--border-gold)] bg-white/80 text-[var(--text-dark)] placeholder-[var(--grey-dark)] focus:outline-none focus:ring-2 focus:ring-[var(--gold)] focus:shadow-lg transition-all">
                    <div class="absolute left-3 top-1/2 -translate-y-1/2 text-[var(--grey-dark)]">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    </div>
                </div>

                <button id="back-button" class="hidden items-center gap-2 text-sm font-medium text-[var(--text-dark)] hover:text-[var(--gold)] transition-all duration-300 px-4 py-2 rounded-xl hover:bg-white/80 hover:shadow-md ml-4 flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12 19 5 12 12 5"></polyline>
                    </svg>
                    ย้อนกลับ
                </button>
            </div>
        </header>

        <main class="container mx-auto px-6 py-8 flex-grow">
            <div id="breadcrumbs" class="mb-6 text-sm font-medium flex items-center gap-2"></div>
            
            <div id="page-title-container" class="mb-8 text-center">
                <h2 id="page-title" class="text-4xl font-bold text-[var(--text-dark)] mb-2"></h2>
                <p id="page-subtitle" class="text-[var(--grey-dark)] text-lg"></p>
            </div>

            <div id="content-area">
                <div id="loader" class="text-center py-10 hidden">
                    <div class="w-12 h-12 border-4 border-t-[var(--green)] border-[var(--grey-light)] rounded-full animate-spin mx-auto"></div>
                    <p class="mt-4 text-[var(--grey-dark)]">กำลังโหลดข้อมูล...</p>
                </div>
                <div id="skeleton-categories" class="hidden">
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
                        <div class="animate-pulse bg-white/50 backdrop-blur-sm p-6 rounded-2xl shadow-lg h-40"></div>
                        <div class="animate-pulse bg-white/50 backdrop-blur-sm p-6 rounded-2xl shadow-lg h-40"></div>
                        <div class="animate-pulse bg-white/50 backdrop-blur-sm p-6 rounded-2xl shadow-lg h-40"></div>
                        <div class="animate-pulse bg-white/50 backdrop-blur-sm p-6 rounded-2xl shadow-lg h-40"></div>
                        <div class="animate-pulse bg-white/50 backdrop-blur-sm p-6 rounded-2xl shadow-lg h-40"></div>
                        <div class="animate-pulse bg-white/50 backdrop-blur-sm p-6 rounded-2xl shadow-lg h-40"></div>
                        <div class="animate-pulse bg-white/50 backdrop-blur-sm p-6 rounded-2xl shadow-lg h-40"></div>
                        <div class="animate-pulse bg-white/50 backdrop-blur-sm p-6 rounded-2xl shadow-lg h-40"></div>
                    </div>
                </div>
                <div id="skeleton-products" class="hidden">
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                        <div class="animate-pulse bg-white/50 backdrop-blur-sm rounded-2xl shadow-lg h-80"></div>
                        <div class="animate-pulse bg-white/50 backdrop-blur-sm rounded-2xl shadow-lg h-80"></div>
                        <div class="animate-pulse bg-white/50 backdrop-blur-sm rounded-2xl shadow-lg h-80"></div>
                        <div class="animate-pulse bg-white/50 backdrop-blur-sm rounded-2xl shadow-lg h-80"></div>
                        <div class="animate-pulse bg-white/50 backdrop-blur-sm rounded-2xl shadow-lg h-80"></div>
                        <div class="animate-pulse bg-white/50 backdrop-blur-sm rounded-2xl shadow-lg h-80"></div>
                        <div class="animate-pulse bg-white/50 backdrop-blur-sm rounded-2xl shadow-lg h-80"></div>
                        <div class="animate-pulse bg-white/50 backdrop-blur-sm rounded-2xl shadow-lg h-80"></div>
                    </div>
                </div>
                <div id="home-page"></div>
                <div id="categories-page" class="hidden"></div>
                <div id="products-page" class="hidden"></div>
                <div id="search-page" class="hidden"></div>
            </div>
        </main>

        <footer class="animated-bg mt-12 py-8 border-t border-white/50">
            <div class="container mx-auto px-6 text-center">
                <div class="flex items-center justify-center gap-2 mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                    </svg>
                    <span class="text-sm font-semibold text-[var(--green-dark)]">GreenBuild Catalog</span>
                </div>
                <p class="text-xs text-[var(--grey-dark)]">&copy; 2024 GreenBuild. วัสดุก่อสร้างรักษ์โลก เพื่ออนาคตที่ยั่งยืน</p>
            </div>
        </footer>
    </div>

    <div id="product-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-300">
        <div id="modal-content" class="animated-bg w-full max-w-4xl max-h-[90vh] rounded-3xl shadow-2xl flex flex-col md:flex-row overflow-hidden transform scale-95 transition-all duration-300 relative">
            <button id="modal-close-btn" class="absolute top-4 right-4 p-2 rounded-full bg-white/50 text-[var(--red-dark)] hover:bg-red-100 hover:scale-110 transition-all z-10">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
    
            <div id="modal-image" class="w-full md:w-1/2 h-64 md:h-auto bg-cover bg-center" style="min-height: 400px;"></div>
            <div id="modal-details" class="w-full md:w-1/2 p-8 overflow-y-auto no-scrollbar">
                <h2 id="modal-title" class="text-3xl font-bold text-[var(--text-dark)] mb-3"></h2>
                <span id="modal-category" class="inline-block px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-semibold mb-4"></span>
                <p id="modal-description" class="text-[var(--grey-dark)] mb-6 leading-relaxed"></p>
                
                <h4 class="font-semibold text-[var(--text-dark)] mb-2">ข้อมูลรับรอง</h4>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-gray-100 p-3 rounded-lg">
                        <span class="text-xs text-gray-500 block">Carbon Footprint</span>
                        <strong id="modal-cfp-value" class="text-lg text-[var(--green)]"></strong>
                    </div>
                    <div class="bg-gray-100 p-3 rounded-lg">
                        <span class="text-xs text-gray-500 block">หน่วย</span>
                        <strong id="modal-cfp-unit" class="text-lg text-[var(--text-dark)]"></strong>
                    </div>
                </div>
                
                <a id="modal-link" href="#" target="_blank" class="inline-flex items-center gap-2 w-full justify-center px-6 py-3 rounded-xl bg-gradient-to-r from-[var(--gold)] to-[var(--gold-hover)] text-white font-bold shadow-lg hover:shadow-xl hover:scale-105 transition-all">
                    ดูรายละเอียดเพิ่มเติม
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                </a>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof tsParticles !== 'undefined') {
                tsParticles.load("particles-bg", {
                    fpsLimit: 60,
                    particles: {
                        number: { value: 60, density: { enable: true, value_area: 800 } },
                        color: { value: "#2e7d32" },
                        shape: { type: "circle" },
                        opacity: {
                            value: 0.3,
                            random: true,
                            anim: { enable: true, speed: 0.5, opacity_min: 0.1, sync: false }
                        },
                        size: {
                            value: 3,
                            random: true,
                            anim: { enable: false }
                        },
                        line_linked: {
                            enable: true,
                            distance: 150,
                            color: "#0d47a1",
                            opacity: 0.2,
                            width: 1
                        },
                        move: {
                            enable: true,
                            speed: 1,
                            direction: "none",
                            random: true,
                            straight: false,
                            out_mode: "out",
                            bounce: false,
                            attract: { enable: false, rotateX: 600, rotateY: 1200 }
                        }
                    },
                    interactivity: {
                        detect_on: "canvas",
                        events: {
                            onhover: { enable: true, mode: "grab" },
                            onclick: { enable: false },
                            resize: true
                        },
                        modes: {
                            grab: { distance: 140, line_opacity: 0.4 }
                        }
                    },
                    retina_detect: true,
                    background: { color: "transparent" }
                });
            }
        });
    </script>
    
    <script>
        function setupScrollToTopButton() {
            const button = document.createElement('button');
            button.id = 'scroll-to-top';
            button.className = 'fixed bottom-6 right-6 p-4 rounded-full shadow-2xl transition-all duration-300 z-40 opacity-0';
            button.style.background = 'linear-gradient(135deg, var(--gold) 0%, var(--gold-hover) 100%)';
            button.style.color = 'var(--white)';
            button.style.display = 'none';
            button.style.position = 'relative';

            button.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="19" x2="12" y2="5"></line>
                    <polyline points="5 12 12 5 19 12"></polyline>
                </svg>
            `;

            document.body.appendChild(button);

            window.addEventListener('scroll', () => {
                if (window.scrollY > 500) {
                    button.style.display = 'block';
                    setTimeout(() => button.style.opacity = '1', 10);
                } else {
                    button.style.opacity = '0';
                    setTimeout(() => button.style.display = 'none', 300);
                }
            });

            button.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
        document.addEventListener('DOMContentLoaded', setupScrollToTopButton);
    </script>
    
    <script>
        function init3DTilt() {
            const cards = document.querySelectorAll('.card-tilt');
            cards.forEach(card => {
                card.addEventListener('mousemove', (e) => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;
                    const rotateX = ((y - centerY) / centerY) * 8;
                    const rotateY = ((x - centerX) / centerX) * -8;
                    card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.05)`;
                });
                card.addEventListener('mouseleave', () => {
                    card.style.transform = 'perspective(1000px) rotateX(0deg) rotateY(0deg) scale(1)';
                });
            });
        }
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const SUPABASE_URL = 'https://pyfxrgrogevqlrqqiwks.supabase.co'; 
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5ZnhyZ3JvZ2V2cWxycXFpd2tzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5OTc4MjUsImV4cCI6MjA3NTU3MzgyNX0.NmTap3b7S5X7yKWfKHLc3KxeLARn9wTHMMpYBDZwWEg';

            if (!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_URL.includes('YOUR_') || SUPABASE_ANON_KEY.includes('YOUR_')) {
                document.getElementById('content-area').innerHTML = `
                    <div class="bg-red-100 border-l-4 border-red-500 text-[var(--red-dark)] p-4 rounded-md" role="alert">
                        <p class="font-bold">การตั้งค่าไม่สมบูรณ์</p>
                        <p>กรุณาใส่ค่า <code>SUPABASE_URL</code> และ <code>SUPABASE_ANON_KEY</code> ที่ถูกต้อง</p>
                    </div>
                `;
                return;
            }
            
            const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            const pageTitle = document.getElementById('page-title');
            const pageSubtitle = document.getElementById('page-subtitle');
            const homePage = document.getElementById('home-page');
            const categoriesPage = document.getElementById('categories-page');
            const productsPage = document.getElementById('products-page');
            const searchPage = document.getElementById('search-page');
            const backButton = document.getElementById('back-button');
            const loader = document.getElementById('loader');
            const skeletonCategories = document.getElementById('skeleton-categories');
            const skeletonProducts = document.getElementById('skeleton-products');
            const breadcrumbs = document.getElementById('breadcrumbs');
            const searchInput = document.getElementById('search-input');
            const modal = document.getElementById('product-modal');
            const modalContent = document.getElementById('modal-content');
            const modalCloseBtn = document.getElementById('modal-close-btn');

            let allFetchedProducts = [];
            let state = {
                view: 'home',
                label: null,
                category: null,
                query: null,
                history: []
            };

            function getCategoryIcon(category) {
                const cat = category.toLowerCase();
                
                if (cat.includes('คอนกรีต') || cat.includes('ซีเมนต์') || cat.includes('ปูน')) {
                    return {
                        svg: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 3v18M3 15h18"/></svg>`,
                        class: 'category-concrete'
                    };
                }
                if (cat.includes('เหล็ก') || cat.includes('โลหะ') || cat.includes('เกลียว')) {
                    return {
                        svg: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/><path d="M12 3v18"/><path d="M3 12h18"/><circle cx="12" cy="12" r="2"/></svg>`,
                        class: 'category-steel'
                    };
                }
                if (cat.includes('ไม้') || cat.includes('wood')) {
                    return {
                        svg: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20"/><path d="M8 6h8"/><path d="M7 10h10"/><path d="M6 14h12"/><path d="M8 18h8"/></svg>`,
                        class: 'category-wood'
                    };
                }
                if (cat.includes('กระเบื้อง') || cat.includes('หลังคา')) {
                    return {
                        svg: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
                        class: 'category-tiles'
                    };
                }
                if (cat.includes('สี') || cat.includes('ทา') || cat.includes('paint')) {
                    return {
                        svg: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.37 2.63L14 7l-1.59-1.59a2 2 0 00-2.82 0L8 7l9 9 1.59-1.59a2 2 0 000-2.82L17 10l4.37-4.37a2.12 2.12 0 10-3-3z"/><path d="M9 8c-2 3-4 3.5-7 4l8 10c2-1 6-5 6-7"/></svg>`,
                        class: 'category-paint'
                    };
                }
                if (cat.includes('กระจก') || cat.includes('แก้ว') || cat.includes('glass')) {
                    return {
                        svg: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 3l18 18"/><circle cx="12" cy="12" r="4" opacity="0.5"/></svg>`,
                        class: 'category-glass'
                    };
                }
                if (cat.includes('ฉนวน') || cat.includes('กันความร้อน') || cat.includes('insulation')) {
                    return {
                        svg: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 14.76V3.5a2.5 2.5 0 00-5 0v11.26a4.5 4.5 0 105 0z"/><path d="M12 12v-8"/></svg>`,
                        class: 'category-insulation'
                    };
                }
                return {
                    svg: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>`,
                    class: 'category-default'
                };
            }

            async function fetchCategories(label) {
                let { data, error } = await _supabase
                    .from('materials')
                    .select('category')
                    .not('category', 'is', null)
                    .eq('label_type', label)
                    .order('category', { ascending: true });

                if (error) throw error;
                const uniqueCategories = [...new Set(data.map(item => item.category))];
                return uniqueCategories;
            }

            async function fetchProducts(category, label) {
                let { data, error } = await _supabase
                    .from('materials')
                    .select('*')
                    .eq('category', category)
                    .eq('label_type', label)
                    .order('product_name', { ascending: true })
                    .limit(100);

                if (error) throw error;
                allFetchedProducts = [...allFetchedProducts, ...data.filter(p => !allFetchedProducts.find(ap => ap.id === p.id))];
                return data;
            }

            async function fetchSearchResults(query) {
                let { data, error } = await _supabase
                    .from('materials')
                    .select('*')
                    .ilike('product_name', `%${query}%`)
                    .limit(50);

                if (error) throw error;
                allFetchedProducts = [...allFetchedProducts, ...data.filter(p => !allFetchedProducts.find(ap => ap.id === p.id))];
                return data;
            }

            function createHomePage() {
                return `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                        <div class="animated-bg p-10 rounded-3xl shadow-xl border-2 border-white/50 cursor-pointer card-hover card-tilt transform transition-all duration-500" onclick="navigateTo('categories', { label: 'CFP' })">
                            <div class="flex justify-center mb-6 float-animation">
                                <div class="w-24 h-24 rounded-3xl bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center shadow-2xl">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a7 7 0 104.9 11.9"/><path d="M7 12l5 5"/><path d="m12 7l5 5"/></svg>
                                </div>
                            </div>
                            <h3 class="text-2xl font-bold mb-3 text-center gradient-text">คาร์บอนฟุตพริ้นท์ของผลิตภัณฑ์</h3>
                            <p class="text-[var(--grey-dark)] text-center leading-relaxed">แสดงค่าการปล่อยก๊ซเรือนกระจกตลอดวัฏจักรชีวิตของผลิตภัณฑ์</p>
                            <div class="mt-6 flex justify-center"><span class="px-4 py-2 bg-green-100 text-green-700 rounded-full text-sm font-semibold">CFP Label</span></div>
                        </div>
                        <div class="animated-bg p-10 rounded-3xl shadow-xl border-2 border-white/50 cursor-pointer card-hover card-tilt transform transition-all duration-500" onclick="navigateTo('categories', { label: 'CFR' })">
                            <div class="flex justify-center mb-6 float-animation" style="animation-delay: 0.2s;">
                                <div class="w-24 h-24 rounded-3xl bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center shadow-2xl">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><path d="M9 22V12h6v10"/><path d="M12 2v7"/><circle cx="12" cy="9" r="2"/></svg>
                                </div>
                            </div>
                            <h3 class="text-2xl font-bold mb-3 text-center" style="background: linear-gradient(135deg, var(--blue) 0%, #1976d2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ลดคาร์บอนขององค์กร</h3>
                            <p class="text-[var(--grey-dark)] text-center leading-relaxed">แสดงว่าผลิตภัณฑ์ได้ผ่านการรับรองเครื่องหมายลดคาร์บอน</p>
                            <div class="mt-6 flex justify-center"><span class="px-4 py-2 bg-blue-100 text-blue-700 rounded-full text-sm font-semibold">CFR Label</span></div>
                        </div>
                    </div>
                `;
            }

            function createCategoryCard(category, index) {
                const delay = index * 50;
                const iconData = getCategoryIcon(category);
                
                return `
                    <div class="animated-bg p-6 rounded-2xl shadow-xl border border-white/50 cursor-pointer card-hover card-tilt flex flex-col items-center text-center transition-all duration-500 opacity-0 translate-y-4" style="animation: slide-up 0.5s ease-out forwards ${delay}ms;" onclick="navigateTo('products', { category: '${category}' })">
                        <div class="icon-container ${iconData.class} shadow-xl">
                            ${iconData.svg}
                        </div>
                        <h3 class="font-bold text-[var(--text-dark)] text-lg leading-tight">${category}</h3>
                        <div class="mt-3 w-16 h-1 bg-gradient-to-r from-transparent via-green-500 to-transparent rounded-full"></div>
                    </div>
                `;
            }

            function createProductCard(material, index) {
                const delay = index * 50;
                const imageUrl = material.image_url && material.image_url !== 'N/A' 
                    ? material.image_url 
                    : `https://placehold.co/400x300/e8f5e9/2e7d32?text=${encodeURIComponent(material.product_name || 'No Image')}`;

                const linkAction = `onclick="showProductModal('${material.id}')"`;

                return `
                    <div class="animated-bg rounded-2xl shadow-xl border border-white/50 overflow-hidden flex flex-col card-hover card-tilt cursor-pointer transition-all duration-500 opacity-0 translate-y-4" style="animation: slide-up 0.5s ease-out forwards ${delay}ms;" ${linkAction}>
                        <div class="product-card-img">
                            <img src="${imageUrl}"
                                alt="${material.product_name || 'รูปภาพสินค้า'}"
                                class="w-full h-56 object-cover"
                                onerror="this.onerror=null;this.src='https://placehold.co/400x300/ffebee/c62828?text=ไม่พบรูปภาพ';">
                        </div>
                        <div class="p-5 flex-grow flex flex-col">
                            <h3 class="font-semibold text-[var(--text-dark)] text-lg leading-tight mb-3 flex-grow" title="${material.product_name || ''}">
                                ${material.product_name || 'ไม่มีชื่อสินค้า'}
                            </h3>
                        </div>
                    </div>
                `;
            }

            function updateUI() {
                homePage.classList.add('hidden');
                categoriesPage.classList.add('hidden');
                productsPage.classList.add('hidden');
                searchPage.classList.add('hidden');
                loader.classList.add('hidden');
                skeletonCategories.classList.add('hidden');
                skeletonProducts.classList.add('hidden');

                if (state.history.length > 0) {
                    backButton.classList.remove('hidden');
                    backButton.style.display = 'flex';
                } else {
                    backButton.classList.add('hidden');
                }

                switch (state.view) {
                    case 'home':
                        pageTitle.textContent = 'แคตตาล็อกวัสดุก่อสร้างรักษ์โลก';
                        pageSubtitle.textContent = 'เลือกประเภทฉลากที่คุณต้องการค้นหา';
                        homePage.innerHTML = createHomePage();
                        homePage.classList.remove('hidden');
                        break;
                    case 'categories':
                        pageTitle.textContent = `หมวดหมู่สินค้า ${state.label ? '(' + state.label + ')' : ''}`;
                        pageSubtitle.textContent = 'เลือกหมวดหมู่เพื่อดูรายการสินค้า';
                        skeletonCategories.classList.remove('hidden');
                        renderCategories(state.label);
                        break;
                    case 'products':
                        pageTitle.textContent = state.category;
                        pageSubtitle.textContent = `รายการสินค้าในหมวดหมู่ ${state.category}`;
                        skeletonProducts.classList.remove('hidden');
                        renderProducts(state.category, state.label);
                        break;
                    case 'search':
                        pageTitle.textContent = `ผลการค้นหา: "${state.query}"`;
                        pageSubtitle.textContent = `พบสินค้าที่ตรงกับคำค้นหาของคุณ`;
                        skeletonProducts.classList.remove('hidden');
                        renderSearchResults(state.query);
                        break;
                }
                
                updateBreadcrumbs();
                setTimeout(init3DTilt, 100);
            }

            async function renderCategories(label) {
                try {
                    const categories = await fetchCategories(label);
                    categoriesPage.innerHTML = `
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
                            ${categories.map((cat, index) => createCategoryCard(cat, index)).join('')}
                        </div>
                    `;
                    categoriesPage.classList.remove('hidden');
                } catch (error) {
                    categoriesPage.innerHTML = `
                        <div class="animated-bg p-6 rounded-2xl shadow-lg border border-red-200 text-center">
                            <p class="text-red-600 font-semibold">เกิดข้อผิดพลาด: ${error.message}</p>
                        </div>
                    `;
                    categoriesPage.classList.remove('hidden');
                } finally {
                    skeletonCategories.classList.add('hidden');
                }
            }

            async function renderProducts(category, label) {
                try {
                    const products = await fetchProducts(category, label);
                    if (products.length === 0) {
                        productsPage.innerHTML = `
                            <div class="animated-bg p-12 rounded-2xl shadow-lg text-center">
                                <p class="text-xl text-[var(--grey-dark)] font-semibold">ไม่พบสินค้าในหมวดหมู่ ${category}</p>
                            </div>`;
                    } else {
                        productsPage.innerHTML = `
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                                ${products.map((prod, index) => createProductCard(prod, index)).join('')}
                            </div>
                        `;
                    }
                    productsPage.classList.remove('hidden');
                } catch (error) {
                    productsPage.innerHTML = `
                        <div class="animated-bg p-6 rounded-2xl shadow-lg border border-red-200 text-center">
                            <p class="text-red-600 font-semibold">เกิดข้อผิดพลาด: ${error.message}</p>
                        </div>
                    `;
                    productsPage.classList.remove('hidden');
                } finally {
                    skeletonProducts.classList.add('hidden');
                }
            }

            async function renderSearchResults(query) {
                try {
                    const results = await fetchSearchResults(query);
                    if (results.length === 0) {
                        searchPage.innerHTML = `<div class="animated-bg p-12 rounded-2xl shadow-lg text-center">
                            <p class="text-xl text-[var(--grey-dark)] font-semibold">ไม่พบสินค้าที่ตรงกับ "${query}"</p>
                        </div>`;
                    } else {
                        searchPage.innerHTML = `
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                                ${results.map((prod, index) => createProductCard(prod, index)).join('')}
                            </div>
                        `;
                    }
                    searchPage.classList.remove('hidden');
                } catch (error) {
                    searchPage.innerHTML = `
                        <div class="animated-bg p-6 rounded-2xl shadow-lg border border-red-200 text-center">
                            <p class="text-red-600 font-semibold">เกิดข้อผิดพลาด: ${error.message}</p>
                        </div>
                    `;
                    searchPage.classList.remove('hidden');
                } finally {
                    skeletonProducts.classList.add('hidden');
                }
            }
            
            function navigateTo(view, params = {}) {
                if (state.view !== view || JSON.stringify(state) !== JSON.stringify({ ...state, ...params })) {
                    state.history.push({ ...state });
                }
                state = { ...state, view, ...params };
                
                if (view === 'home') {
                    state.label = null;
                    state.category = null;
                    state.query = null;
                } else if (view === 'categories') {
                    state.category = null;
                    state.query = null;
                } else if (view === 'products') {
                    state.query = null;
                } else if (view === 'search') {
                    state.label = null;
                    state.category = null;
                }

                updateUI();
            }

            function goBack() {
                if (state.history.length > 0) {
                    const previousState = state.history.pop();
                    state = previousState;
                    updateUI();
                }
            }

            function updateBreadcrumbs() {
                let path = [];
                if (state.view !== 'home') {
                    path.push({ name: 'หน้าแรก', action: () => navigateTo('home') });
                }
                if (state.label) {
                    path.push({ name: state.label, action: () => navigateTo('categories', { label: state.label }) });
                }
                if (state.category) {
                    path.push({ name: state.category, action: null });
                }
                if (state.query) {
                    path.push({ name: `ค้นหา: "${state.query}"`, action: null });
                }

                breadcrumbs.innerHTML = path.map((item, index) => {
                    const isLast = index === path.length - 1;
                    const linkClass = isLast 
                        ? 'text-[var(--text-dark)] font-bold px-3 py-2 bg-white/50 rounded-lg' 
                        : 'text-[var(--grey-dark)] hover:text-[var(--green)] cursor-pointer transition-all duration-300 px-3 py-2 rounded-lg hover:bg-white/80 hover:shadow-md';
                    const element = isLast 
                        ? `<span class="${linkClass}">${item.name}</span>`
                        : `<span class="${linkClass}" onclick="(${item.action.toString().replace(/"/g, '\'')})()">${item.name}</span>`;
                    
                    return element + (isLast ? '' : `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><polyline points="9 18 15 12 9 6"></polyline></svg>`);
                }).join('');
            }

            window.showProductModal = (id) => {
                const material = allFetchedProducts.find(p => p.id == id);
                if (!material) return;

                const imageUrl = material.image_url && material.image_url !== 'N/A' 
                    ? material.image_url 
                    : `https://placehold.co/600x600/e8f5e9/2e7d32?text=${encodeURIComponent(material.product_name || 'No Image')}`;

                document.getElementById('modal-image').style.backgroundImage = `url('${imageUrl}')`;
                document.getElementById('modal-title').textContent = material.product_name || 'ไม่มีชื่อสินค้า';
                document.getElementById('modal-category').textContent = material.category || 'ไม่มีหมวดหมู่';
                document.getElementById('modal-description').textContent = material.description || 'ไม่มีคำอธิบายสำหรับสินค้านี้';
                document.getElementById('modal-cfp-value').textContent = material.cfp_value || 'N/A';
                document.getElementById('modal-cfp-unit').textContent = material.cfp_unit || 'N/A';
                
                const modalLink = document.getElementById('modal-link');
                if (material.detail_page_url && material.detail_page_url.trim() !== '') {
                    modalLink.href = material.detail_page_url;
                    modalLink.style.display = 'inline-flex';
                } else {
                    modalLink.style.display = 'none';
                }

                modal.style.display = 'flex';
                setTimeout(() => {
                    modal.classList.remove('opacity-0', 'pointer-events-none');
                    modalContent.classList.remove('scale-95');
                }, 10);
            };

            const hideModal = () => {
                modal.classList.add('opacity-0', 'pointer-events-none');
                modalContent.classList.add('scale-95');
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
            };

            backButton.addEventListener('click', goBack);
            
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && searchInput.value.trim() !== '') {
                    navigateTo('search', { query: searchInput.value.trim() });
                    searchInput.blur();
                }
            });

            modalCloseBtn.addEventListener('click', hideModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    hideModal();
                }
            });

            window.navigateTo = navigateTo;
            updateUI();
        });
    </script>
</body>
</html>